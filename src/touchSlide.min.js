/*
  Auther:f7
  Date:2013.8
  Editor: 201401120
  Versions:1.0.5
*/
(function(win,d){function TouchSlide(elem,o){this.versions="1.0.5";if(!(this instanceof TouchSlide)){return new TouchSlide(elem,o);};if(typeof(elem)=="string"&&elem.indexOf("#")>=0){elem=elem.replace("#","");};this.elem=typeof(elem)=="object"?elem:d.getElementById(elem);this.moveElem="";this.o=o||{};this.speed=this.o.speed||300;this.index=this.o.index||0;this.range=0;this.zoom=false;this.items=[];this.createtag=this.o.createtag||"div";this.loop=this.o.loop||false;this.threshold=this.o.threshold||25;this.auto=this.o.auto||false;this.height=this.o.height||false;this.ratio=this.o.ratio||"";this.history=this.o.history||false;this.autoFlag=true;this.suspend=this.o.suspend||3000;this.init();};TouchSlide.prototype.getStyle=function(elem,key){var value=elem.style[key];if(!value){var style=elem.currentStyle||getComputedStyle(elem,null);value=style[key];};return value;};TouchSlide.prototype.init=function(){if(!this.elem){return false};var winWidth=d.body.offsetWidth,_width=this.elem.offsetWidth;if(this.history){this.index=this.urlParam(window.location.href,"touchslidepage")||this.index;};if(this.o.range){if(this.o.range>winWidth){this.range=winWidth;this.zoom=true;}else{this.range=this.o.range;};}else{if(_width>=winWidth){this.range=winWidth;this.zoom=true;}else{this.range=_width;};};this.setbox();this.addevent();this.amendHeight(this.index);this.setHistory();if(this.o.ready){this.o.ready(this);};this.action();};TouchSlide.prototype.setbox=function(){var data=this.elem.innerHTML,_inner=d.createElement(this.createtag),_last,_first,count=0,transitionValue,translateValue,that=this,nodes;this.elem.innerHTML="";_inner.innerHTML=data;this.elem.appendChild(_inner);this.moveElem=_inner;this.moveElem.style.overflow="hidden";if(this.items.length==0){nodes=this.moveElem.childNodes;for(var i=0,l=nodes.length;i<l;i++){if(nodes[i].nodeType==3||nodes[i].nodeType==8){continue;};this.items.push(nodes[i]);};};count=this.items.length;for(var i=0,l=count;i<l;i++){this.items[i].style.width=this.range+"px";};if(this.index>=count){this.index=count-1;};translateValue="translate("+-(this.range*this.index)+"px, 0)";if(this.loop){_last=this.items[count-1].cloneNode(true);_first=this.items[0].cloneNode(true);this.moveElem.insertBefore(_last,this.items[0]);this.moveElem.appendChild(_first);count+=2;translateValue="translate("+-(this.range*(this.index+1))+"px, 0)";};this.setTranslate(translateValue);transitionValue=this.speed+"ms";this.moveElem.style.width=count*this.range+"px";this.setTransition(transitionValue);if(this.ratio&&this.ratio.indexOf("/")>0){var __w=this.ratio.substring(0,this.ratio.indexOf("/")),__h=this.ratio.replace(__w+"/","");this.moveElem.style.height=(this.range*parseInt(__h))/parseInt(__w)+"px";for(var i=0,l=count;i<l;i++){this.items[i].style.height="100%";};};};TouchSlide.prototype.goto=function(count,flag){var translateValue,all=this.items.length,that=this;if(!this.loop){if(count>=all){count=all-1;};if(count<=0){count=0;};translateValue="translate("+-(this.range*count)+"px, 0)";}else{if(count>all){count=all;};if(count<=-1){count=-1;};translateValue="translate("+-(this.range*(count+1))+"px, 0)";if(count==-1||count==all){count==-1?count=this.items.length-1:count=0;this.index=count;setTimeout(function(){that.resetLoopTranslate();},this.speed);};};this.setTranslate(translateValue);this.index=count;this.amendHeight(this.index);if(!flag||flag!="history"){this.setHistory();};if(this.o.end&&(!flag||flag!="reset")){this.o.end(that);};};TouchSlide.prototype.resetLoopTranslate=function(){var transitionValue=this.speed+"ms",translateValue,that=this;if(this.index==this.items.length-1){this.setTransition("none");translateValue="translate("+-(this.range*(this.index+1))+"px, 0)";this.setTranslate(translateValue);setTimeout(function(){that.setTransition(transitionValue);},10);};if(this.index==0){this.setTransition("none");translateValue="translate("+-this.range+"px, 0)";this.setTranslate(translateValue);setTimeout(function(){that.setTransition(transitionValue);},10);};};TouchSlide.prototype.setTransition=function(val){this.moveElem.style.WebkitTransition=val;this.moveElem.style.MozTransition=val;this.moveElem.style.OTransition=val;this.moveElem.style.transition=val;};TouchSlide.prototype.setTranslate=function(val){this.moveElem.style.WebkitTransform=val;this.moveElem.style.MozTransform=val;this.moveElem.style.OTransform=val;this.moveElem.style.transform=val;};TouchSlide.prototype.next=function(){var count=this.index+1;this.goto(count);};TouchSlide.prototype.prev=function(){var count=this.index-1;this.goto(count);};TouchSlide.prototype.addevent=function(){var that=this,x,y,elemX,transitionValue=this.speed+"ms",cro=0,flag=false;win.addEventListener("resize",function(){that.winresize()},false);this.moveElem.addEventListener("mousedown",start,false);this.moveElem.addEventListener("click",clear,false);this.moveElem.addEventListener("mouseup",end,false);this.moveElem.addEventListener("mouseout",end,false);this.moveElem.ontouchstart=start;this.moveElem.ontouchend=end;function clear(){};function start(e){var reg=/-?[0-9]+/g,translate=this.style.webkitTransform||this.style.mozTransform||this.style.oTransform||this.style.transform;flag=true;if(that.auto&&that.autoFlag){that.stop()};if(!e.targetTouches){e.preventDefault();};elemX=parseInt(translate.substring(translate.indexOf("translate")+10,translate.indexOf("px")));x=e.clientX||e.targetTouches[0].pageX;y=e.clientY||e.targetTouches[0].pageY;that.setTransition("none");document.addEventListener("mousemove",move,false);document.ontouchmove=move;cro=0;};function end(e){var _x=e.clientX||e.changedTouches[0].pageX;flag=false;that.setTransition(transitionValue);if(cro==1){that.moveAnalysis(_x-x);};if(that.auto&&that.loop&&!that.autoFlag){that.start()};document.removeEventListener("mousemove",move,false);that.moveElem.removeEventListener("mouseout",end,false);document.removeEventListener("touchmove",move,false);that.moveElem.removeEventListener("touchend",end,false);document.removeEventListener("mouseup",end,false);};function move(e){var newX=e.clientX||e.targetTouches[0].pageX,newY=e.clientY||e.targetTouches[0].pageY,translateValue="translate("+(newX-x+elemX)+"px, 0)",rangeX=newX-x,rangeY=newY-y;rangeX<0?rangeX*=-1:rangeX;rangeY<0?rangeY*=-1:rangeY;document.addEventListener("mouseup",end,false);if(e.touches&&e.touches.length>1){that.goto(that.index);return false;};if(rangeX>rangeY&&cro==0){cro=1;e.preventDefault();};if(rangeX<rangeY&&cro==0){cro=2;};if(cro==1&&flag){that.setTranslate(translateValue);};if(cro==2){e.cancelable=false;};};if(this.history){window.addEventListener("hashchange",function(){var up=that.urlParam(window.location.href,"touchslidepage");if(up!=that.index){that.goto(parseInt(up),"history");};},false);};};TouchSlide.prototype.moveAnalysis=function(range){if(range>this.threshold){this.prev();}else if(range<-this.threshold){this.next();}else{this.goto(this.index);};};TouchSlide.prototype.action=function(){var that=this;if(this.auto&&!this.loop&&that.index==(this.items.length-1)){setTimeout(function(){that.goto(0);that.stop();},this.suspend+this.speed);return false;};if(this.auto&&this.autoFlag){this.timer=setTimeout(function(){clearTimeout(that.timer);that.next();that.action();},this.suspend+this.speed);};};TouchSlide.prototype.winresize=function(){var that=this;clearTimeout(this.resizeTimer);this.resizeTimer=setTimeout(function(){var winWidth=d.body.offsetWidth,count=that.items.length,elemWidth=that.elem.offsetWidth,nodes;if(that.range>winWidth){that.zoom=true;};if(!that.zoom){return false};if(winWidth==that.range){return false};if(elemWidth!=winWidth){that.range=elemWidth;}else{that.range=winWidth;};if(that.loop){count+=2;};that.moveElem.style.width=count*that.range+"px";nodes=that.moveElem.childNodes;for(var i=0,l=nodes.length;i<l;i++){if(nodes[i].nodeType==3||nodes[i].nodeType==8){continue;};nodes[i].style.width=that.range+"px";};if(that.ratio&&that.ratio.indexOf("/")>0){var __w=that.ratio.substring(0,that.ratio.indexOf("/")),__h=that.ratio.replace(__w+"/","");that.moveElem.style.height=(that.range*parseInt(__h))/parseInt(__w)+"px";};that.goto(that.index,"reset");if(that.o.resize){that.o.resize(that);};},100);};TouchSlide.prototype.amendHeight=function(i){if(!this.height){return false};var elem=this.items[i],_height=elem.clientHeight;this.elem.style.height=_height+"px";this.elem.style.overflow="hidden";};TouchSlide.prototype.urlParam=function(url,name,value){var reg=new RegExp("(^|\\#|&)"+name+"=([^&]*)(\\s|&|$)","i"),m=url.match(reg);if(typeof(value)!='undefined'){if(m){return url.replace(reg,function($0,$1,$2){return $0.replace($2,value);});}else{if(url.indexOf('#')==-1){return(url+'#'+name+'='+value);}else{return(url+'&'+name+'='+value);};};}else{return m?m[2]:'';};};TouchSlide.prototype.setHistory=function(){if(!this.history){return false};window.location=this.urlParam(window.location.href,"touchslidepage",this.index);};TouchSlide.prototype.stop=function(){clearTimeout(this.timer);this.autoFlag=false;};TouchSlide.prototype.start=function(){this.autoFlag=true;this.action();};win.TouchSlide=TouchSlide;})(window,document);